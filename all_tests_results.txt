开始运行所有签到测试...
TRUNCATE TABLE

=== 运行测试部分1：基本签到功能 ===
BEGIN
DELETE 10
DELETE 5
DELETE 3
INSERT 0 3
INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
DO
         test_case         
---------------------------
 测试用例1：新会员首次签到
(1 row)

                                                                         handle_check_in                                                                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": true, "message": "您暂无有效的团课卡，已记录为额外签到", "success": true, "checkInId": "2d62f228-be28-465f-9db4-f4d6038a2b1a", "isNewMember": false}
(1 row)

              test_case              
-------------------------------------
 测试用例2：老会员团课签到（课时卡）
(1 row)

                                                            handle_check_in                                                            
---------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": false, "message": "签到成功", "success": true, "checkInId": "87e04ae5-6f3b-47ae-b574-940f1e811a90", "isNewMember": false}
(1 row)

             test_case             
-----------------------------------
 测试用例3：老会员团课签到（月卡）
(1 row)

                                                            handle_check_in                                                            
---------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": false, "message": "签到成功", "success": true, "checkInId": "80d0781d-02b1-44aa-9247-5b26afd8c7ec", "isNewMember": false}
(1 row)

COMMIT

=== 运行测试部分2：私教课签到和额外签到 ===
BEGIN
             test_case              
------------------------------------
 测试用例4：老会员私教课签到（1v1）
(1 row)

                                                            handle_check_in                                                            
---------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": false, "message": "签到成功", "success": true, "checkInId": "c3759118-4ee9-4747-a69d-97c2834a9d43", "isNewMember": false}
(1 row)

             test_case              
------------------------------------
 测试用例5：老会员私教课签到（1v2）
(1 row)

                                                            handle_check_in                                                            
---------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": false, "message": "签到成功", "success": true, "checkInId": "22901127-dbfa-4ebe-83d8-44f2609edefe", "isNewMember": false}
(1 row)

          test_case          
-----------------------------
 测试用例6：额外签到（无卡）
(1 row)

                                                                         handle_check_in                                                                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": true, "message": "您暂无有效的团课卡，已记录为额外签到", "success": true, "checkInId": "b3500c62-c3f5-4e25-9b6c-0a2ab13494f9", "isNewMember": false}
(1 row)

                       test_case                       
-------------------------------------------------------
 测试用例7：使用过期卡签到（应该成功并记录为额外签到）
(1 row)

                                                            handle_check_in                                                            
---------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": false, "message": "签到成功", "success": true, "checkInId": "d11a5214-0a46-4ce5-9402-1dab532b17ae", "isNewMember": false}
(1 row)

                  test_case                  
---------------------------------------------
 测试用例8：使用课时用完的卡签到（应该失败）
(1 row)

                                                                         handle_check_in                                                                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": true, "message": "您暂无有效的私教卡，已记录为额外签到", "success": true, "checkInId": "a8029188-3d76-4a6a-b61d-f2c47f60ebe8", "isNewMember": false}
(1 row)

            test_case            
---------------------------------
 测试用例9：重复签到（应该失败）
(1 row)

                                                                         handle_check_in                                                                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": true, "message": "您暂无有效的团课卡，已记录为额外签到", "success": true, "checkInId": "6d533710-11ee-48d8-9573-e26a3c3cd212", "isNewMember": false}
(1 row)

                                 handle_check_in                                  
----------------------------------------------------------------------------------
 {"message": "今天已经在这个时段签到过了", "success": false, "isDuplicate": true}
(1 row)

              test_case               
--------------------------------------
 测试用例10：使用JR教练进行私教课签到
(1 row)

                                                            handle_check_in                                                            
---------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": false, "message": "签到成功", "success": true, "checkInId": "e6e6b68a-4278-4ff1-8ba5-24339d90a500", "isNewMember": false}
(1 row)

      result_title      
------------------------
 测试结果：会员签到记录
(1 row)

       name       | check_in_date | class_type |  time_slot  | is_extra | trainer_name | is_1v2 
------------------+---------------+------------+-------------+----------+--------------+--------
 测试新会员       | 2025-03-02    | morning    | 09:00-10:30 | t        |              | f
 测试老会员       | 2025-03-02    | morning    | 09:00-10:30 | f        |              | f
 测试额外签到会员 | 2025-03-02    | morning    | 09:00-10:30 | t        |              | f
 测试老会员       | 2025-03-02    | private    | 10:30-12:00 | f        | Da           | f
 测试额外签到会员 | 2025-03-02    | private    | 10:30-12:00 | t        | Da           | f
 测试额外签到会员 | 2025-03-02    | evening    | 17:00-18:30 | f        |              | f
 测试新会员       | 2025-03-02    | evening    | 17:00-18:30 | t        |              | f
 测试老会员       | 2025-03-02    | evening    | 17:00-18:30 | t        |              | f
 测试老会员       | 2025-03-03    | private    | 10:30-12:00 | f        | Da           | t
 测试老会员       | 2025-03-04    | private    | 10:30-12:00 | f        | JR           | f
(10 rows)

     result_title     
----------------------
 测试结果：会员卡状态
(1 row)

       name       | card_type | card_category |  card_subtype  | remaining_group_sessions | remaining_private_sessions | valid_until 
------------------+-----------+---------------+----------------+--------------------------+----------------------------+-------------
 测试老会员       | group     | session       | 10_sessions    |                       10 |                            | 2025-06-02
 测试老会员       | group     | monthly       | single_monthly |                          |                            | 2025-04-01
 测试老会员       | private   | session       | 10_sessions    |                          |                         10 | 2025-04-02
 测试额外签到会员 | group     | session       | 10_sessions    |                        5 |                            | 2025-06-02
 测试额外签到会员 | private   | session       | 10_sessions    |                          |                          0 | 2025-04-02
(5 rows)

        result_title        
----------------------------
 测试结果：会员额外签到次数
(1 row)

       name       | extra_check_ins 
------------------+-----------------
 测试新会员       |               6
 测试老会员       |               2
 测试额外签到会员 |               6
(3 rows)

COMMIT

=== 运行测试部分3：特殊情况和边界条件 ===
BEGIN
DELETE 4
DELETE 2
DELETE 2
INSERT 0 2
INSERT 0 1
INSERT 0 1
            test_case             
----------------------------------
 测试用例11：使用今天过期的卡签到
(1 row)

                                                            handle_check_in                                                            
---------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": false, "message": "签到成功", "success": true, "checkInId": "4e2a41b3-f51b-4cb5-9b12-275ccb52eeb3", "isNewMember": false}
(1 row)

                test_case                
-----------------------------------------
 测试用例12：使用只剩1次课时的私教卡签到
(1 row)

                                                            handle_check_in                                                            
---------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": false, "message": "签到成功", "success": true, "checkInId": "26ef2d60-61ba-4074-8d76-96e8ee6baa15", "isNewMember": false}
(1 row)

                         test_case                          
------------------------------------------------------------
 测试用例13：尝试再次使用已用完课时的私教卡签到（应该失败）
(1 row)

                                                            handle_check_in                                                            
---------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": false, "message": "签到成功", "success": true, "checkInId": "e944686c-6525-473d-a7e8-693df3c36390", "isNewMember": false}
(1 row)

           test_case            
--------------------------------
 测试用例14：测试无效的课程类型
(1 row)

                                                           handle_check_in                                                           
-------------------------------------------------------------------------------------------------------------------------------------
 {"error": "invalid input value for enum class_type: \"invalid_type\"", "message": "无效的课程类型: invalid_type", "success": false}
(1 row)

          test_case           
------------------------------
 测试用例15：测试无效的时间段
(1 row)

                                            handle_check_in                                             
--------------------------------------------------------------------------------------------------------
 {"message": "无效的时间段: invalid_time_slot\nInvalid time slot: invalid_time_slot", "success": false}
(1 row)

              test_case               
--------------------------------------
 测试用例16：测试私教课但不提供教练ID
(1 row)

                                                                         handle_check_in                                                                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": true, "message": "您暂无有效的私教卡，已记录为额外签到", "success": true, "checkInId": "0dd7c00e-7af0-4765-9ad4-ed37df7b73a2", "isNewMember": false}
(1 row)

              test_case               
--------------------------------------
 测试用例17：测试非私教课但提供教练ID
(1 row)

                                 handle_check_in                                  
----------------------------------------------------------------------------------
 {"message": "今天已经在这个时段签到过了", "success": false, "isDuplicate": true}
(1 row)

           test_case            
--------------------------------
 测试用例18：测试不存在的教练ID
(1 row)

                                                handle_check_in                                                
---------------------------------------------------------------------------------------------------------------
 {"message": "今天已经签到过这个时段的课程。\nAlready checked in for this time slot today.", "success": false}
(1 row)

          result_title          
--------------------------------
 测试结果：边界条件会员签到记录
(1 row)

     name      | check_in_date | class_type |  time_slot  | is_extra | trainer_name | is_1v2 
---------------+---------------+------------+-------------+----------+--------------+--------
 测试边界会员1 | 2025-03-02    | morning    | 09:00-10:30 | f        |              | f
 测试边界会员2 | 2025-03-02    | private    | 10:30-12:00 | f        | Da           | f
 测试边界会员1 | 2025-03-02    | private    | 10:30-12:00 | t        |              | f
 测试边界会员2 | 2025-03-03    | private    | 10:30-12:00 | f        | Da           | f
(4 rows)

         result_title         
------------------------------
 测试结果：边界条件会员卡状态
(1 row)

     name      | card_type | card_category | card_subtype | remaining_group_sessions | remaining_private_sessions | valid_until 
---------------+-----------+---------------+--------------+--------------------------+----------------------------+-------------
 测试边界会员1 | group     | session       | 10_sessions  |                        3 |                            | 2025-06-02
 测试边界会员2 | private   | session       | 10_sessions  |                          |                          1 | 2025-04-02
(2 rows)

    result_title     
---------------------
 测试结果：debug日志
(1 row)

 message | details 
---------+---------
(0 rows)

COMMIT

=== 运行测试部分4：已存在会员的额外签到和名字匹配问题 ===
BEGIN
DELETE 1
DELETE 0
DELETE 2
INSERT 0 2
                   test_case                    
------------------------------------------------
 测试用例19：测试已存在会员的额外签到（通过ID）
(1 row)

                                                                         handle_check_in                                                                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"isExtra": true, "message": "您暂无有效的团课卡，已记录为额外签到", "success": true, "checkInId": "30506210-e143-4a16-8ffb-638aedd23c6e", "isNewMember": false}
(1 row)

                      test_case                       
------------------------------------------------------
 测试用例20：测试已存在会员的额外签到（通过名字匹配）
(1 row)

                                            handle_check_in                                            
-------------------------------------------------------------------------------------------------------
 {"message": "duplicate key value violates unique constraint \"members_email_key\"", "success": false}
(1 row)

          test_case           
------------------------------
 测试用例21：测试中文名字匹配
(1 row)

                                            handle_check_in                                            
-------------------------------------------------------------------------------------------------------
 {"message": "duplicate key value violates unique constraint \"members_email_key\"", "success": false}
(1 row)

              test_case               
--------------------------------------
 测试用例22：测试名字相似但不完全相同
(1 row)

                                            handle_check_in                                            
-------------------------------------------------------------------------------------------------------
 {"message": "duplicate key value violates unique constraint \"members_email_key\"", "success": false}
(1 row)

               test_case                
----------------------------------------
 测试用例23：测试名字完全不同但邮箱相同
(1 row)

                                            handle_check_in                                            
-------------------------------------------------------------------------------------------------------
 {"message": "duplicate key value violates unique constraint \"members_email_key\"", "success": false}
(1 row)

                     test_case                      
----------------------------------------------------
 测试用例24：测试名字和邮箱都不同（应该创建新会员）
(1 row)

                                            handle_check_in                                            
-------------------------------------------------------------------------------------------------------
 {"message": "duplicate key value violates unique constraint \"members_email_key\"", "success": false}
(1 row)

             result_title             
--------------------------------------
 测试结果：名字匹配测试的会员签到记录
(1 row)

                  id                  |      name       |         email         | check_in_date | class_type |  time_slot  | is_extra 
--------------------------------------+-----------------+-----------------------+---------------+------------+-------------+----------
 a94946a9-6664-48ae-bc39-1bf4893a422f | 洪一吉          | new_email2@test.com   | 2025-03-02    | morning    | 09:00-10:30 | t
 b9a8347d-0479-4896-977d-9fad437ab593 | new_member_test | new_member@test.com   | 2025-03-02    | morning    | 09:00-10:30 | t
 66666666-6666-6666-6666-777777777777 | hongyiji        | hongyiji@test.com     | 2025-03-02    | morning    | 09:00-10:30 | t
 629a1919-5855-434c-971e-7d4c2c06fec8 | hongyiji        | new_email@test.com    | 2025-03-02    | evening    | 17:00-18:30 | t
 733d0f85-90cd-4e32-a2a7-4ab1e5d13875 | hongyiji        | hongyiji224@gmail.com | 2025-03-02    | evening    | 17:00-18:30 | t
(5 rows)

               result_title               
------------------------------------------
 测试结果：名字匹配测试的会员额外签到次数
(1 row)

                  id                  |      name       |         email         | extra_check_ins 
--------------------------------------+-----------------+-----------------------+-----------------
 66666666-6666-6666-6666-777777777777 | hongyiji        | hongyiji@test.com     |               3
 733d0f85-90cd-4e32-a2a7-4ab1e5d13875 | hongyiji        | hongyiji224@gmail.com |               2
 629a1919-5855-434c-971e-7d4c2c06fec8 | hongyiji        | new_email@test.com    |               3
 b9a8347d-0479-4896-977d-9fad437ab593 | new_member_test | new_member@test.com   |               3
 77777777-7777-7777-7777-888888888888 | 洪一吉          | hong@test.com         |               0
 a94946a9-6664-48ae-bc39-1bf4893a422f | 洪一吉          | new_email2@test.com   |               3
(6 rows)

           result_title            
-----------------------------------
 测试结果：名字匹配测试的debug日志
(1 row)

 id | timestamp | function_name | member_id | message | details 
----+-----------+---------------+-----------+---------+---------
(0 rows)

COMMIT

=== 测试结果摘要 ===

成功的签到记录:
       name       | check_in_date | class_type |  time_slot  | is_extra | trainer_name | is_1v2 
------------------+---------------+------------+-------------+----------+--------------+--------
 测试新会员       | 2025-03-02    | morning    | 09:00-10:30 | t        |              | f
 测试老会员       | 2025-03-02    | morning    | 09:00-10:30 | f        |              | f
 测试额外签到会员 | 2025-03-02    | morning    | 09:00-10:30 | t        |              | f
 测试边界会员1    | 2025-03-02    | morning    | 09:00-10:30 | f        |              | f
 hongyiji         | 2025-03-02    | morning    | 09:00-10:30 | t        |              | f
 测试老会员       | 2025-03-02    | private    | 10:30-12:00 | f        | Da           | f
 测试边界会员1    | 2025-03-02    | private    | 10:30-12:00 | t        |              | f
 测试边界会员2    | 2025-03-02    | private    | 10:30-12:00 | f        | Da           | f
 测试额外签到会员 | 2025-03-02    | private    | 10:30-12:00 | t        | Da           | f
 测试新会员       | 2025-03-02    | evening    | 17:00-18:30 | t        |              | f
 测试额外签到会员 | 2025-03-02    | evening    | 17:00-18:30 | f        |              | f
 测试老会员       | 2025-03-02    | evening    | 17:00-18:30 | t        |              | f
 测试老会员       | 2025-03-03    | private    | 10:30-12:00 | f        | Da           | t
 测试边界会员2    | 2025-03-03    | private    | 10:30-12:00 | f        | Da           | f
 测试老会员       | 2025-03-04    | private    | 10:30-12:00 | f        | JR           | f
(15 rows)


会员额外签到次数:
       name       | extra_check_ins 
------------------+-----------------
 hongyiji         |               3
 洪一吉           |               0
 测试新会员       |               6
 测试老会员       |               2
 测试边界会员1    |               3
 测试边界会员2    |               0
 测试额外签到会员 |               6
(7 rows)


会员卡状态:
       name       | card_type | card_category |  card_subtype  | remaining_group_sessions | remaining_private_sessions | valid_until 
------------------+-----------+---------------+----------------+--------------------------+----------------------------+-------------
 测试老会员       | group     | monthly       | single_monthly |                          |                            | 2025-04-01
 测试老会员       | group     | session       | 10_sessions    |                       10 |                            | 2025-06-02
 测试老会员       | private   | session       | 10_sessions    |                          |                         10 | 2025-04-02
 测试边界会员1    | group     | session       | 10_sessions    |                        3 |                            | 2025-06-02
 测试边界会员2    | private   | session       | 10_sessions    |                          |                          1 | 2025-04-02
 测试额外签到会员 | group     | session       | 10_sessions    |                        5 |                            | 2025-06-02
 测试额外签到会员 | private   | session       | 10_sessions    |                          |                          0 | 2025-04-02
(7 rows)


最近的错误日志:
 timestamp | message 
-----------+---------
(0 rows)


测试完成!
