CREATE OR REPLACE FUNCTION validate_check_in() RETURNS trigger AS $$ DECLARE v_member RECORD; v_card RECORD; v_daily_check_ins integer; v_has_same_class_check_in boolean; BEGIN SELECT * INTO v_member FROM members WHERE id = NEW.member_id FOR UPDATE; IF NOT FOUND THEN RAISE EXCEPTION '会员不存在
Member not found'; END IF; SELECT EXISTS (SELECT 1 FROM check_ins WHERE member_id = NEW.member_id AND check_in_date = NEW.check_in_date AND class_type = NEW.class_type AND id IS DISTINCT FROM NEW.id) INTO v_has_same_class_check_in; IF v_has_same_class_check_in THEN RAISE EXCEPTION '今天已经在这个时段签到过了
Already checked in for this class type today'; END IF; IF NEW.card_id IS NOT NULL THEN SELECT * INTO v_card FROM membership_cards WHERE id = NEW.card_id FOR UPDATE; IF NOT FOUND THEN RAISE EXCEPTION '会员卡不存在
Membership card not found'; END IF; IF v_card.member_id != NEW.member_id THEN RAISE EXCEPTION '会员卡不属于该会员
Membership card does not belong to this member'; END IF; IF (v_card.card_type = 'group' AND NEW.class_type = 'private') OR (v_card.card_type = 'private' AND NEW.class_type != 'private') THEN NEW.is_extra := true; ELSIF v_card.valid_until IS NOT NULL AND v_card.valid_until < NEW.check_in_date THEN NEW.is_extra := true; ELSIF v_card.card_type = 'group' AND v_card.card_category = 'session' AND (v_card.remaining_group_sessions IS NULL OR v_card.remaining_group_sessions <= 0) THEN NEW.is_extra := true; ELSIF v_card.card_type = 'private' AND (v_card.remaining_private_sessions IS NULL OR v_card.remaining_private_sessions <= 0) THEN NEW.is_extra := true; ELSIF v_card.card_type = 'group' AND v_card.card_category = 'monthly' THEN SELECT COUNT(*) INTO v_daily_check_ins FROM check_ins WHERE member_id = NEW.member_id AND check_in_date = NEW.check_in_date AND id IS DISTINCT FROM NEW.id AND NOT is_extra; IF (v_card.card_subtype = 'single_monthly' AND v_daily_check_ins >= 1) OR (v_card.card_subtype = 'double_monthly' AND v_daily_check_ins >= 2) THEN NEW.is_extra := true; ELSE NEW.is_extra := false; END IF; ELSE NEW.is_extra := false; END IF; ELSE NEW.is_extra := true; END IF; INSERT INTO debug_logs (function_name, member_id, message, details) VALUES ('validate_check_in', NEW.member_id, CASE WHEN NEW.is_extra THEN '额外签到' ELSE '正常签到' END, jsonb_build_object('check_in_date', NEW.check_in_date, 'class_type', NEW.class_type, 'is_extra', NEW.is_extra, 'card_id', NEW.card_id, 'card_info', CASE WHEN v_card.id IS NOT NULL THEN jsonb_build_object('card_type', v_card.card_type, 'card_category', v_card.card_category, 'card_subtype', v_card.card_subtype, 'valid_until', v_card.valid_until, 'remaining_group_sessions', v_card.remaining_group_sessions, 'remaining_private_sessions', v_card.remaining_private_sessions) ELSE NULL END, 'daily_check_ins', v_daily_check_ins)); RETURN NEW; END; $$ LANGUAGE plpgsql;
